bits 32 ; target processor mode

; import fucntion 
extern puts

section .text	; text section containing code
global strlen_custom;
strlen_custom:
	push ebp
	mov ebp,  esp
	push edi	; saved register
	xor eax, eax
	xor ecx, ecx
	dec ecx
	mov edi, [ebp + 0x8]
	repnz scasb
	neg ecx
	sub ecx, 2
	mov eax, ecx	; restore register
	pop edi
	leave
	ret

global toUppercase
toUppercase:	; void toUppercase(char* s)
	push ebp
	mov ebp, esp
	sub esp,  0x100
	
	xor ebx, ebx	; ebx = i
	mov edi, [ebp + 0x8]	; edi = buffer
	mov dword[esp], edi

	call strlen_custom
	mov ecx, eax	; ecx = n
	jmp condition
doing:
	movzx eax, BYTE[edi + ebx]
	cmp eax, 0x61	; 'a'
	jl increment
	cmp eax, 0x7A	; 'z'
	jg increment
	sub eax, 0x20
	mov BYTE[edi + ebx], al
increment:
	inc ebx
condition:
	cmp ebx, ecx
	jng doing	; i < n
	leave
	ret

global main	; int main ... (not static or private in OOP)
main:
	push ebp
	mov ebp, esp
	sub esp, 0x100
	push welcome
	call puts

	; memset
	xor eax, eax
	mov ecx, 0x21
	lea edi, [ebp - 0x30]
	rep stosb

	; using syscall read
	lea ecx, [ebp - 0x30]	; buf
	mov edx, 0x21	; 0x20 + newline
	mov ebx, 0	; stdin
	mov eax, 0x3
	int 0x80

	; print	
	lea eax, [ebp - 0x30]
	mov BYTE[eax + 0x20],0	; set null
	push eax
	call toUppercase
	call puts
	
	add esp, 0x100
	leave
	ret

section .rodata
welcome: db "--- asm #3 uppercase ---",0
