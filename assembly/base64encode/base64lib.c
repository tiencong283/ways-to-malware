#include <string.h>
#include <stdlib.h>
#include <stdio.h>


char const* base64table = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";

char* base64encode(char const* input){
	size_t len = strlen(input);
	size_t bufferSize = (len + 2)/3;
	bufferSize = bufferSize*4;
	
	char* buffer = (char*)malloc(bufferSize + 1);
	memset(buffer, 0, bufferSize + 1);
	
	int bi = 0, i = 0;
	int n = ((int)len/3)*3;
	for (i = 0; i<n; i+=3){
		buffer[bi++] = base64table[input[i] >> 2];
		buffer[bi++] = base64table[((input[i] % 4) << 4) + (input[i+1] >> 4)];
		buffer[bi++] = base64table[((input[i+1] % 16) << 2) + (input[i+2] >> 6)];
		buffer[bi++] = base64table[input[i+2] % 64];
	}
	if (len % 3 == 1){
		buffer[bi++] = base64table[input[i] >> 2];
		buffer[bi++] = base64table[((input[i] % 4) << 4) + (input[i+1] >> 4)];
		buffer[bi++] = '=';
		buffer[bi++] = '=';
	}

	if (len % 3 == 2){
		buffer[bi++] = base64table[input[i] >> 2];
		buffer[bi++] = base64table[((input[i] % 4) << 4) + (input[i+1] >> 4)];
		buffer[bi++] = base64table[((input[i+1] % 16) << 2) + (input[i+2] >> 6)];
		buffer[bi++] = '=';
	}
	return buffer;
}
int main(int argc, char** argv){
	if (argc < 2){
		printf("Usage: %s <input>\n", argv[0]);
		return 0;
	}
	char const* input = argv[1];
	printf("input: '%s'\n", input);

	puts(base64encode(input));
	return 0;
}
