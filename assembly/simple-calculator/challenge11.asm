bits 64	

extern fgets
extern stdin
extern puts
extern printf
extern strtol
extern strlen

section .text
; rbp
;- 0x65	input
;- 0x6d endptr
;- 0x80 num
; rsp
global readInt	; 
readInt:
	push rbp
	mov rbp, rsp
	sub rsp, 0x100
	mov r12, rdi
	mov r13, rsi
	mov r14, rdx
inf_loop2:
	mov rdi, r12
	call printf

	lea rdi, [rbp - 0x65] 	; input
	mov esi, 0x65
	mov rdx, qword[stdin]
	call fgets

	lea rdi, [rbp - 0x65]
	call strlen 	
	dec eax
	cdq
	mov BYTE[rbp - 0x65 + rax], 0
	
	lea rdi, [rbp - 0x65]
	lea rsi, [rbp - 0x6d]
	mov edx, 0xA
	call strtol
	mov dword[rbp - 0x80], eax	; cast long -> int
	mov rax, qword[rbp - 0x6d]
	cmp BYTE[rax], 0 
	jz leave2
	mov rdi, r13
	call puts
	jmp inf_loop2

leave2:
	mov eax, dword[rbp  - 0x80]
	mov dword[r14], eax
	leave
	ret
global main
main:
	push rbp
	mov rbp, rsp
	sub rsp, 0x200
	
	mov rdi, welcome
	call puts
	mov rdi, features
	call puts
	mov rdi, options
	call puts
	mov rdi, line_b
	call puts
inf_loop:
	lea rdx, [rsp + 0x20]	; userChoice
	mov rsi, choice_err
	mov rdi, choice_prompt
	call readInt	
	mov eax, dword[rsp + 0x20]
	cmp eax, 1
	jl err
	cmp eax, 4
	jle read_ops
err:
	mov rdi, choice_err
	call puts
	jmp inf_loop
;	mov esi, dword[rsp + 0x20]
;	mov rdi,  int_fmt
;	call printf

read_ops:
	lea rdx, [rsp + 0x24]	; num1
	mov rsi, op_err
	mov rdi, op1_prompt
	call readInt
	
	lea rdx, [rsp + 0x28]	; num2
	mov rsi, op_err
	mov rdi, op2_prompt
	call readInt
	
	mov eax, dword[rsp + 0x24]
	cdq
	mov r12, rax
	mov eax, dword[rsp + 0x28]
	cdq
	mov r13, rax
	mov bl, 0 		; bl => + - * /
	mov eax,  dword[rsp + 0x20]		
	cmp eax, 1
	jz add
	cmp eax, 2
	jz minus
	cmp eax, 3
	jz multiply
	cmp eax, 4
	jz divide
	jmp inf_loop
divide:
	mov bl, 47
	xorpd xmm0, xmm0
	xorpd xmm1, xmm1

	cvtsi2sd xmm0, r12d	
	cvtsi2sd xmm1, r13d	
	divsd xmm0, xmm1
	jmp print_ans
multiply:
	mov bl, 42
	mov rax, r12
	imul r13
	xorpd xmm0, xmm0
	cvtsi2sd xmm0, rax	
	jmp print_ans
minus:
	mov bl, 45
	mov rax, r12
	sub rax, r13
	xorpd xmm0, xmm0
	cvtsi2sd xmm0, rax	
	jmp print_ans
add:
	mov bl, 43
	mov rax, r12
	add rax, r13
	xorpd xmm0, xmm0
	cvtsi2sd xmm0, rax
print_ans:
	
	mov ecx, r13d
	movzx edx, bl
	mov esi, r12d
	mov edi, result_fmt
	call printf
	jmp inf_loop
	leave
	ret

section .rodata
welcome: db "--- # challenge 11 simple calculator ---", 0x0
features: db "--- features ---", 0x0
options: db "1.Add",0xA,"2.Sub",0xA,"3.Mul",0xA,"4.Div", 0x0
line_b: db "---   ---", 0x0

choice_prompt: db "Enter your choice: ", 0x0
choice_err: db "Please enter a number in range [1-4]", 0x0

op1_prompt: db "Enter operand 1: ", 0x0
op2_prompt: db "Enter operand 2: ", 0x0
op_err: db "Please enter a valid int number", 0x0

int_fmt: db "%d", 0x0
result_fmt: db "%d %c %d = %.2lf", 0x0A, 0
