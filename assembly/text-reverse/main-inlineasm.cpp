#include <Windows.h>
#include <winuser.h>

#define BUF_SIZE 1024

char buffer[BUF_SIZE];

const char* windowClassName = "templateWndClass";
const char* title = "Challenge #15 - Text Reverse";
const char* editWndClass = "EDIT";
const char* staticWndClass = "STATIC";
const char* buttonWndClass = "BUTTON";

const char* enterStr = "Enter string: ";
const char* reversedStr = "Reversed string: ";
const char* aboutStr = "About";
const char* info = "Win32api & assembly practice\ncongh4@viettel.com.vn";

HWND enterEditBox = NULL;	// a pointer to its struct
HWND reversedEditBox = NULL;
HWND aboutButton = NULL;

// like memset(mem, 0, size)
void __declspec(naked) customMemsetZero() {	// void* mem, size
	__asm {
		push ebp
		mov ebp, esp
		/*

		*/
		mov edi, dword ptr[ebp + 0x8]	// mem
		mov ecx, dword ptr[ebp + 0xc]	// size
		xor eax, eax
		rep stosb	// rep until ecx is zero and eax -> byte ptr[edi]

		leave
		ret
	}
}
//char* reverseBuf(char* buf) {
//	size_t bufLen = strlen(buf);
//	for (int i = 0; i < bufLen / 2; ++i) {
//		char tc = buf[i];
//		buf[i] = buf[bufLen - 1 - i];
//		buf[bufLen - 1 - i] = tc;
//	}
//	return buf;
//}

void __declspec(naked) __stdcall reverseBuf(char* buf) {
	__asm {
		push ebp
		mov ebp, esp
		sub esp, 0x10
		/*	
			ebp - 0x4	; bufLen
			ebp - 0x8 ; bufLen /2
		*/
		mov edi, dword ptr[ebp + 0x8]
		xor al, al	// null
		xor ecx, ecx
		dec ecx	// ecx  = -1
		repnz scasb
		add ecx, 0x2
		neg ecx	// ecx = strlen
		mov dword ptr[ebp - 0x4], ecx
		shr ecx, 1	// /= 2
		mov dword ptr[ebp - 0x8], ecx
		xor ebx, ebx	// i
reverse_loop:
		cmp ebx, dword ptr[ebp - 0x8]
		jg reverse_leave
		mov edi, dword ptr[ebp + 0x8]
		mov al, byte ptr[edi + ebx]	// al = buf[i]

		mov ecx, dword ptr[ebp - 0x4]
		dec ecx
		sub ecx, ebx
		mov dl, byte ptr[edi + ecx]
		mov byte ptr[edi + ecx], al	// buf[strlen(buf) - i - 1] = al
		mov	byte ptr[edi + ebx], dl	// buf[i] = buf[strlen(buf) - i - 1]

		inc ebx
		jmp reverse_loop
reverse_leave:
		mov eax, edi
		leave
		ret
	}
}

LRESULT __declspec(naked) __stdcall WindowProc(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam){
	__asm {
		push ebp
		mov ebp, esp
		sub esp, 0x100
	}
	/*
		ebp - 0x4	; hModule
	
	*/
	__asm {
		mov ebx, dword ptr[ebp + 0xc]	// uMsg
WM_CLOSE_TEST:
		cmp ebx, WM_CLOSE	// close button or alt-f4
		jnz WM_DESTROY_TEST
		push dword ptr[ebp + 0x8]
		call DestroyWindow
		jmp wp_leave
WM_DESTROY_TEST:
		cmp ebx, WM_DESTROY
		jnz WM_CREATE_TEST
		push 0
		call PostQuitMessage
		jmp wp_leave
WM_CREATE_TEST:
		cmp ebx, WM_CREATE
		jnz WM_COMMAND_TEST
		push 0
		call GetModuleHandle
		test eax, eax
		jz	wp_leave
		mov dword ptr[ebp - 0x4], eax
		
		xor al, al
		mov byte ptr[ebp - 0x10], al	// simulate "" str
		

		push 0	// pointer to user data
		push dword ptr[ebp - 0x4]	// hInstances
		push 0	// hMenu
		push dword ptr[ebp + 0x8]	// hWndParent
		push 20	//  nHeight
		push 250	// nWidth 
		push 20	// y	CW_USEDEFAULT -> default
		push 200	// x	CW_USEDEFAULT -> default
		push 0x50800080	// dwStyle	WS_CHILD | WS_VISIBLE | WS_BORDER | ES_AUTOHSCROLL
		lea eax, [ebp - 0x10]
		push eax	// lpWindowName
		push editWndClass	// LPCTSTR lpClassName
		push 0	// extended window style
		call CreateWindowExA
		test eax, eax
		jz wp_leave
		mov enterEditBox, eax

		push 0	// pointer to user data
		push dword ptr[ebp - 0x4]	// hInstances
		push 0	// hMenu
		push dword ptr[ebp + 0x8]	// hWndParent
		push 20	//  nHeight
		push 250	// nWidth 
		push 60	// y	CW_USEDEFAULT -> default
		push 200	// x	CW_USEDEFAULT -> default
		push 0x50800880	// dwStyle	WS_CHILD | WS_VISIBLE | WS_BORDER | ES_AUTOHSCROLL | ES_READONLY
		lea eax, [ebp - 0x10]
		push eax	// lpWindowName
		push editWndClass	// LPCTSTR lpClassName
		push 0	// extended window style
		call CreateWindowExA
		test eax, eax
		jz wp_leave
		mov reversedEditBox, eax

		//  CreateWindow("STATIC", "Enter string: ", WS_CHILD | WS_VISIBLE | SS_LEFT, 10, 20, 180, 20, hwnd, NULL, hModule, NULL);
		push 0	// pointer to user data
		push dword ptr[ebp - 0x4]	// hInstances
		push 0	// hMenu
		push dword ptr[ebp + 0x8]	// hWndParent
		push 20	//  nHeight
		push 150	// nWidth 
		push 20	// y	CW_USEDEFAULT -> default
		push 10	// x	CW_USEDEFAULT -> default
		push 0x50000000	// dwStyle	WS_CHILD | WS_VISIBLE
		push enterStr	// lpWindowName
		push staticWndClass	// LPCTSTR lpClassName
		push 0	// extended window style
		call CreateWindowExA
		test eax, eax
		jz wp_leave

		// CreateWindow("STATIC", "Reversed string: ", WS_CHILD | WS_VISIBLE , 10, 60, 180, 20, hwnd, NULL, hModule, NULL);
		push 0	// pointer to user data
		push dword ptr[ebp - 0x4]	// hInstances
		push 0	// hMenu
		push dword ptr[ebp + 0x8]	// hWndParent
		push 20	//  nHeight
		push 150	// nWidth 
		push 60	// y	CW_USEDEFAULT -> default
		push 10	// x	CW_USEDEFAULT -> default
		push 0x50000000	// dwStyle	WS_CHILD | WS_VISIBLE
		push reversedStr	// lpWindowName
		push staticWndClass	// LPCTSTR lpClassName
		push 0	// extended window style
		call CreateWindowExA
		test eax, eax
		jz wp_leave

		// CreateWindow("BUTTON", "About", WS_CHILD | WS_VISIBLE, 10, 100, 80, 40, hwnd, NULL, hModule, NULL);
		push 0	// pointer to user data
		push dword ptr[ebp - 0x4]	// hInstances
		push 0	// hMenu
		push dword ptr[ebp + 0x8]	// hWndParent
		push 40	//  nHeight
		push 80	// nWidth 
		push 100	// y	CW_USEDEFAULT -> default
		push 10	// x	CW_USEDEFAULT -> default
		push 0x50000000	// dwStyle	WS_CHILD | WS_VISIBLE
		push aboutStr	// lpWindowName
		push buttonWndClass	// LPCTSTR lpClassName
		push 0	// extended window style
		call CreateWindowExA
		test eax, eax
		jz wp_leave
		mov aboutButton, eax

		jmp wp_leave
WM_COMMAND_TEST:
		cmp ebx, WM_COMMAND	
		jnz DEFAULT_TEST
		mov eax, dword ptr[ebp + 0x14]
		cmp eax, enterEditBox	// lParam == (LONG_PTR)enterEditBox
		jnz aboutButton_TEST
		mov eax, dword ptr[ebp + 0x10]
		shr eax, 0x10
		cmp ax, EN_CHANGE	// HIWORD(wParam) == EN_CHANGE
		jnz wp_leave

		push BUF_SIZE
		mov eax, offset buffer	// buffer ~ buffer[0], offset -> buffer
		push eax
		call customMemsetZero

		push BUF_SIZE
		push offset buffer
		push enterEditBox
		call GetWindowText

		push offset buffer
		call reverseBuf
		push eax
		push reversedEditBox
		call SetWindowText
		jmp wp_leave
aboutButton_TEST:
		mov eax, dword ptr[ebp + 0x14]
		cmp eax, aboutButton	// lParam == (LONG_PTR)aboutButton
		jnz wp_leave

		// MessageBox(hwnd, "Win32api & assembly practice\ncongh4@viettel.com.vn", "About", MB_OK | MB_ICONINFORMATION);
		push 0x40
		push aboutStr
		push info
		push dword ptr[ebp + 0x8]
		call MessageBox
		jmp wp_leave

DEFAULT_TEST:
		push dword ptr[ebp + 0x14]
		push dword ptr[ebp + 0x10]
		push dword ptr[ebp + 0xc]
		push dword ptr[ebp + 0x8]
		call DefWindowProc	// default handling
	}
	__asm {
wp_leave:
		leave
		ret
	}
}
int __declspec(naked) __stdcall WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow)
{
	__asm {
		push ebp
		mov ebp, esp
		sub esp, 0x100
	}
	/*
			sizeof(wndClass) = 40
		ebp - 0x28 -> wndClass
		ebp - 0x2c -> hwnd
			sizeof(MSG) = 0x1c
		ebp - 0x50 -> msg
	*/
	__asm {
		push 0x28
		lea eax, [ebp - 0x28]
		mov ebx, eax
		push eax
		call customMemsetZero

		mov eax, dword ptr[ebp + 0x8]	// hInstance
		mov dword ptr[ebx + 0x10], eax
		mov eax, windowClassName
		mov dword ptr[ebx + 0x24], eax	// window class name
		mov eax, WindowProc
		mov dword ptr[ebx + 0x4], eax	// window class name

		push ebx
		call RegisterClassA
		test eax, eax
		jz ep_leave
		
		push 0	// pointer to user data
		push dword ptr[ebp + 0x8]	// hInstances
		push 0	// hMenu
		push 0	// hWndParent
		push 200	//  nHeight
		push 500	// nWidth 
		push 0x80000000	// y	CW_USEDEFAULT -> default
		push 0x80000000	// x	CW_USEDEFAULT -> default
		push WS_OVERLAPPEDWINDOW	// dwStyle
		push title	// lpWindowName
		push windowClassName	// LPCTSTR lpClassName
		push 0	// extended window style
		call CreateWindowExA
		test eax, eax
		jz	ep_leave
		mov dword ptr[ebp - 0x30], eax
		
		push dword ptr[ebp + 0x14]
		push eax	// hWnd
		call ShowWindow

		lea ebx, [ebp - 0x50]
		push 0x50
		push ebx
		call customMemsetZero

ep_getmsg_loop:
		lea ebx, [ebp - 0x50]

		push 0	// last message at
		push 0	// first message at
		push 0	//	hWnd, NULL -> all
		push ebx	// lpMsg
		call GetMessage
		test eax, eax
		jz ep_leave

		push ebx
		call TranslateMessage	// do some additional processing
		push ebx
		call DispatchMessage	// deliver messages to its handlers
		// after function return, automatically free space by passing arguments so no need to add esp, 0x..

		jmp ep_getmsg_loop
	}
	__asm {
ep_leave:
		leave
		ret
	}
}