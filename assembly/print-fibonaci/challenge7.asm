bits 64 ; target processor mode

; import fucntion 
extern puts
extern fgets
extern stdout
extern printf
extern scanf
extern setbuf

section .text	; text section containing code
global next_fibonacci	
next_fibonacci:
	push rbp
	mov rbp, rsp

	mov r12d, edi	; f0
	mov r13d, esi	; f1
	mov r14d, edx	; idx
	cmp r14d, 2
	jz leave2
	add r12d, r13d
	mov rdi, int_fmt
	mov esi, r12d
	call printf
	dec r14d
	
	mov edi, r13d
	mov esi, r12d
	mov edx, r14d
	call next_fibonacci

leave2:
	leave
	ret

global main	; int main ... (not static or private in OOP)
main:
	push rbp
	mov rbp, rsp
	sub rsp, 0x200
	mov rdi, welcome
	call puts

	mov rsi, 0
	mov rdi, [stdout]
	call setbuf	; unbuffered

	; push 0x203d206e	; 'n = ' not working
	mov rdi, n_prompt
	call printf 
	
	mov rdi, int_read_fmt
	lea rsi, [rsp + 0x10]	; n = rsp + 0x10
	call scanf

	mov ebx, [rsp + 0x10]
	test ebx, ebx
	js failed_n
	jz leave	; >= 1

	mov rsi, 0	; print 0
	mov rdi, int_fmt	
	call printf

	cmp ebx, 2	; >= 2
	jl leave

	mov rsi, 1	; print 1
	mov rdi, int_fmt	
	call printf
	
	mov edi, 0
	mov esi, 1
	mov edx, dword [rsp + 0x10]
	call next_fibonacci

	jmp leave
	; mov rdi, int_fmt
	; mov rsi, [rsp + 0x10]
	; call printf
failed_n:
	mov rdi, error_msg
	call puts
leave:
	mov rdi, newline
	call printf
	leave
	ret

section .rodata
welcome: db "--- asm #7 print n first fibonaccis---",0
int_read_fmt: db "%d", 0
int_fmt: db "%d ", 0
newline: db 0xA, 0
n_prompt: db "n = ", 0
error_msg: db "please enter non-negative n", 0
